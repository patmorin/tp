\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}
\usepackage{bbm}  % needed for \mathbbm{1}
\usepackage{listings}

\usepackage[normalem]{ulem}
\usepackage{cancel}
%\usepackage{enumitem}

\usepackage{todonotes}

% etoolbox allows for robust commands that don't need \protect, e.g.
% \newrobustcmd{\onesub}{\mathord{\includegraphics{figs/one-sub}}}
% \subsection{Approximate Voronoi Diagrams in $G^{\onesub}_k$}
\usepackage{etoolbox}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
% \linenumbers
% \rightlinenumbers
% \linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

\newcommand{\vol}[1]{\boxplus_{#1}}


\DeclareMathOperator{\interior}{Int}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}

\definecolor{brightmaroon}{rgb}{0.76, 0.13, 0.28}
\definecolor{linkblue}{rgb}{0, 0.337, 0.227}
\newcommand{\defin}[1]{\emph{\color{brightmaroon}#1}}
\setlength{\parskip}{1ex}

% Document-specific commands and math operators
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\td}{td}
\DeclareMathOperator{\chicen}{\chi_{\mathrm{cen}}}
\DeclareMathOperator{\chilin}{\chi_{\mathrm{lin}}}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\vor}{Vor}

% \newcommand{\SS}{\mathcal{S}}

\DeclareMathOperator{\binomial}{binomial}

\newrobustcmd{\onesub}{\mathord{\includegraphics{figs/one-sub}}}
\newrobustcmd{\leftup}{\mathord{\includegraphics{figs/left-up}}}

\title{\MakeUppercase{Bad News for Product Structure of Bounded-Degree Graphs}}
% \author{Prosenjit~Bose, Vida~Dujmović, Hussein~Houdrouge, Mehrnoosh~Javarsineh, and Pat~Morin}
\author{%
  Prosenjit Bose\thanks{School of Computer Science, Carleton University, Ottawa, Canada}\, \thanks{Research partly supported by NSERC.} \quad
  Gwenaël Joret\thanks{Affilation/funding} \quad
  Vida Dujmović\thanks{Department of Computer Science and Electrical Engineering, University of Ottawa, Ottawa, Canada.}\,\, \footnotemark[2] \quad
  Piotr Micek\thanks{Affilation/funding}\quad
  Pat Morin\footnotemark[1]\, \footnotemark[2] \quad
  David R. Wood\thanks{School of Mathematics, Monash University, Melbourne, Australia (\texttt{david.wood@monash.edu}). Research supported by the Australian Research Council.}
}

\DeclareMathOperator{\VE}{\mathit{VE}}

\date{}


\begin{document}

\maketitle
\renewcommand{\E}{\mathbb{E}}
\renewcommand{\Pr}{\mathbb{P}}

\begin{abstract}
  We describe a family $\mathcal{G}$ of planar graphs of maximum degree $5$ such that, if an $n$-vertex member of $\mathcal{G}$ is a subgraph of the product of a graph $H$, a path $P$ and a clique $K$ where $H$ has treewidth $t$ and maximum degree $\Delta$ and $K$ has order $r$, then $\log(t\Delta r) \in \Omega(\log n)$.
\end{abstract}

\section{Introduction}

Recently, product structure theorems and the related notion of row treewidth have been a key tool in resolving a number of longstanding open problems on planar graphs.  Roughly, a \defin{product structure theorem} for a graph family $\mathcal{G}$ states that there exists integers $t$ and $c$ such that, for every $G\in\mathcal{G}$ there is a graph $H$ of treewidth at most $t$ and a path $P$ such that $G$ is isomorphic to a subgraph of the strong product of $H$, $P$, and a clique $K$ of order $c$.\footnote{A \defin{tree decomposition} of a graph $H$ is a sequence $\mathcal{T}:=(B_x:x\in V(T))$ of subsets of $V(H)$ indexed by the nodes of some tree $T$ such that
\begin{inparaenum}[(i)]
  \item for each $v\in V(H)$, the induced subgraph $T[x\in V(T):v\in B_x]$ is connected; and
  \item for each edge $vw\in E(H)$, there exists some $x\in V(T)$ with $\{v,w\}\subseteq B_x$.
\end{inparaenum}
The \defin{width} of a tree decomposition of $\mathcal{T}$ is $\max\{|B_x|:x\in V(T)\}-1$. The \defin{treewidth} of $H$ is the minimum width of any tree decomposition of $H$.}\footnote{The \defin{strong product} $G_1\boxtimes G_2$ of two graphs $G_1$ and $G_2$ is the graph with vertex set $V(G_1\boxtimes G_2):=V(G_1)\times V(G_2)$ and that includes the edge with endpoints $(v,x)$ and $(w,y)$ if and only if
\begin{inparaenum}[(i)]
  \item $vw\in E(G_1)$ and $x=y$;
  \item $v=w$ and $xy\in E(G_2)$; or
  \item $vw\in E(G_1)$ and $xy\in E(G_2)$.
\end{inparaenum}
}
This is typically written as $G\subseteq H\boxtimes P\boxtimes K$, where the notation $G_1\subseteq G_2$ is used to mean that $G_1$ is isomorphic to some subgraph of $G_2$.

In applications of product structure theorems, it is often helpful if, in addition to having treewidth $t$, the graph $H$ has additional useful properties, possibly inherited from $G$.  For example, one very useful version of the planar product structure theorem states that for every planar graph $G$ there exists $H$ and $P$ with $G\subseteq H\boxtimes P\boxtimes K_3$ where the treewidth of $H$ is at most $3$ and $H$ is also \emph{planar}.  The planarity of $H$ in this result has been leveraged to obtain better constants and even asymptotic improvements for a number of graph colouring and layout problems, including queue number \cite{X} and vertex ranking \cite{X}.

One question that arises frequently (and which the authors have been asked repeatedly) is the following:
\begin{quote}
  Let $\mathcal{G}_\Delta$ be the family of planar graphs of maximum degree $\Delta$.  Does $\mathcal{G}_\Delta$ have a product structure theorem in which (in addition to having treewidth $t$) $H$ has maximum degree that is bounded by a function of $\Delta$?
\end{quote}
In this note we show that, unfortunately, the answer to this question is no, even when $\Delta=5$.

\begin{thm}\label{main_thm}
  There exists $\epsilon > 0$ such that, for infinitely many integers $n\ge 1$, there exists an $n$-vertex max-degree-$5$ planar graph $G$ such that, for any treewidth-$t$ max-degree-$\Delta$ graph $H$, any path $P$, and any integer $c$,  if $G\subseteq H\boxtimes P\boxtimes K_r$ then $\Delta t\in\Omega(\log^\epsilon n)$.
\end{thm}

\todo[inline]{Maybe it's worth pointing out that these graphs can be triangulated so that they have maximum degree $7$?  I don't want to get into a race to the bottom, since I suspect some variation on our graph can be triangulated to have maximum degree $6$.}

\section{The New Proof}


\subsection{Preliminaries}

Here any throughout, all graphs are simple, connected, and undirected.  For a graph $G$, $V(G)$ denotes the vertex set of $G$ and $E(G)$ denotes the edge set of $G$.  For a set $S$, $G[S]$ denote the subgraph of $G$ induced by $S\cap V(G)$.

\subsubsection{Partitions}

Let $G$ and $H$ be graphs.\footnote{Here and throughout, all graphs are simple connected and undirected}  An \defin{$H$-partition} $\mathcal{H}:=\{B_x:x\in V(H)\}$ of $G$ is a partition  of $V(G)$ into a subsets indexed by the vertices of $H$, called \defin{parts}, with the property that, if $vw$ is an edge of $G$ with $v\in B_x$ and $w\in B_y$ then $x=y$ or $xy\in E(H)$.  The \defin{width} of $\mathcal{H}$ is the size of its largest part, minus one; i.e., $\max\{|B_x|:x\in V(H)\}-1$.

If $H$ comes from a class $\mathcal{G}$ of graphs then we may call $\mathcal{H}$ a $\mathcal{G}$-partition of $G$.  Specifically, if $H$ is a tree, then $\mathcal{H}$ is a \defin{tree-partition} of $G$ and if $\mathcal{H}$ is a path, then $\mathcal{H}$ is a \defin{path-partition} of $G$.  A path-partition $\mathcal{P}:=\{P_x:x\in v(P)\}$ of $G$ is also referred to as a \defin{layering} of $G$ and the parts of $\mathcal{P}$ are referred to as \defin{layers}.  A set of layers $\{P_{x_1},\ldots,P_{x_r}\}\subseteq\mathcal{P}$ is \defin{consecutive} if $P[\{x_1,\ldots,x_r\}]$ is connected.


As in previous works, we make use of the following relationship between $H$-partitions and strong products, which follows immediately from the preceding definitions.

\begin{obs}\label{partitions_vs_products}
  For any integer $c\ge 1$, and any graphs $G$, $H$, and $P$,  $G$ is a subgraph of $H\boxtimes P\boxtimes K_c$ if and only if $G$ has an $H$-partition $\mathcal{H}:=\{B_x:x\in V(H)\}$ and a $P$-partition $\mathcal{P}:=\{P_y:y\in V(P)\}$ such that $|B_x\cap P_y|\le c$, for any $(x,y)\in V(H)\boxtimes V(P)$.
\end{obs}

% \begin{obs}\label{partitions_vs_products}
%   For any integer $c\ge 1$ and any graphs $G$ and $H$,  $G\subseteq H\boxtimes K_c$ if and only if $G$ has an $H$-partition of width at most $c-1$.
% \end{obs}

The following important result of \citet{ding.oporowski:some} allows us to focus on the case where the first factor in our product is a tree.

\begin{lem}[\citet{ding.oporowski:some}]\label{dingy}
  If $H$ is a graph with maximum-degree $\Delta$ and treewidth $t$, then $H$ has a tree partition of width at most $24\Delta t-1$.
\end{lem}

\begin{cor}
  If $G\subseteq H\boxtimes P\boxtimes K_c$ where $H$ has treewidth $t$ and maximum degree $\Delta$ then there exists a tree $T$ such that $G\subseteq T\boxtimes P\boxtimes K_{24c\Delta t}$. 
\end{cor}

\begin{proof}
  By \cref{dingy}, $H$ has a tree-partition $\mathcal{T}:=(B_x:x\in V(T))$ of width at most $24\Delta t-1$ so, by \cref{partitions_vs_products}, $H \subseteq T\boxtimes K_{24\Delta t}$.  Therefore, $H\subseteq T\boxtimes K_{24\Delta t}\boxtimes P\boxtimes K_c = T\boxtimes P\boxtimes K_{24c\Delta t}$.\footnote{Here and throughout we write $G_1=G_2$ to say that the graphs $G_1$ and $G_2$ are isomorphic.}
\end{proof}


The \defin{length} of a path $v_0,\ldots,v_r$ is the number, $r$ of edges in the path. For any two vertices $v,w\in V(G)$, $\dist_G(v,w)$ denotes the minimum length of a path in $G$ that contains $v$ and $w$. For any $R\subseteq V(G)$, the \defin{diameter} of $R$ is $\diam_G(R):=\max\{\dist_G(v,w):v,w\in R\}$.  The following observation follows immediately from these definitions:

\begin{obs}\label{diameter_spread}
  Let $G$ be any graph and let $R\subseteq V(G)$ and let $\mathcal{L}$ be any layering of $G$.  Then there exist some layer $L\in\mathcal{L}$ such that $|R\cap L|\ge |R|/(\diam_G(R)+1)$.
\end{obs}

\begin{proof}
  By the definition of layering, the vertices in $R$ appear in at most $\diam_G(R)+1$ consecutive layers of $\mathcal{L}$. The result then follows from the pigeonhole principle.
\end{proof}


We will also make use of the following basic fact about tree partitions:

\begin{obs}\label{tree_thingy}
  Let $G$ be a graph, let $\mathcal{T}:=(B_x:x\in V(T))$ be a tree partition of $G$, let $x\in V(T)$, and let $v,w\in V(G)\setminus B_x$ be such that
  \begin{inparaenum}[(a)] 
    \item $v$ and $w$ are in the same component of $G-B_x$; and 
    \item $v$ and $w$ each have a neighbour in $B_x$.
  \end{inparaenum}
  Then $T$ contains an edge $xy$ with $v,w\in B_y$.
\end{obs}

\begin{proof}
  Suppose otherwise and that $v\in B_y$ and $w\in B_z$ for some $y\neq z$.  Since each of $v$ and $w$ have a neighbour in $B_x$, $T$ contains the edges $xy$ and $xz$.  Since $v$ and $w$ are in the same component of $G-B_x$, $G$ contains a path from $v$ to $w$ that avoids all vertices in $B_x$, which implies that $T$ contains a path $P_{yz}$ from $y$ to $z$ that does not include $x$.  But this is a contradiction since then $P_{yz}$ and the edges $xy$ and $yz$ form a cycle in $T$.
\end{proof}

\subsubsection{Percolation in Binary Trees}


The \defin{depth} of a node $v$ in a rooted tree $T$ is the length of the path $P_T(v)$ from $v$ to the root of $T$.  Each node $a\in V(P_T(w))$ is an \defin{ancestor} of $w$ and $w$ is a \defin{descendant} of each node in $V(P_T(w))$.  We say that a set $B\subset V(T)$ is \defin{genetically independent} if the no vertex of $B$ is an ancestor of any other vertex in $B$.  For each $h\in\N$, let $T_h$ denote the complete binary tree of height $h$; i.e., the rooted ordered tree with $2^h$ leaves, each having depth $h$ and in which each non-leaf node has exactly two children.  

We will make use of the following percolation-type results. 

\begin{lem}\label{one_path}
  Let $h\ge 1$, let $T_h$ be a complete binary tree of height $h$ with root $v_0$, and let $S\subseteq V(T_h)$ with $|S|< 2^h$. Then there exists a vertex $v_1$ of $T_h$ such that
  \begin{compactenum}[(i)]
    \item the depth of $v_1$ is at most $\log_2(|S|)+1$;
    \item the parent of $v_1$ is in $S\cup\{v_0\}$; and
    \item $T_h-S$ contains a path from $v_1$ to a leaf of $T_h$.
  \end{compactenum} 
\end{lem}

\begin{proof}
  The proof is by induction on $h$.  When $h=1$, $|S|\le 1$. In particular, at least one child $v_1$ of $v_0$ is not in $S$.  The depth of $v_1$ is $1\le \log_2(|S|)+1$, so $v_1$ satisfies (i).  The parent of $v_1$ is $v_0\in\{S\cup\{v_0\}$, so $v_1$ satisifies (ii).  $T_1-S$ contains a path from $v_1$ to itself (a leaf of $T_1$), so $v_1$ satisfies (iii).

  For $h\ge 2$, let $\ell$ be the maximum integer such that $S\cup\{v_0\}$ contains all $2^\ell$ vertices of depth $\ell$.  Observe that $2^\ell \le |S|$, so $\ell \le \log_2 |S| < h$.  Let $L$ be the set of $2^{\ell+1}$ depth $\ell+1$ nodes in $T_h$.  By the Pigeonhole Principle some node $v_0'\in L$ is the root of a complete binary tree $T'$ with root $v'$ of height $h-\ell-1$ with $|S\cap V(T')| \le |S|/2^{\ell+1} < 2^{h-\ell+1}$.  Applying induction on $T'$ and $S':=S\cap V(T')$ we obtain a vertex $v_1'$ of depth at most $\ell+1+\log_2(|S'|)+1 \le \log_2(|S|)+1$ whose parent is in $S\cup\{v_0'\}$, and such that $T_h-S$ contains a path from $v_1'$ to a leaf of $T_h$.  Thus $v_1'$ satisfies requirements (i) and (iii).  If the parent of $v_1'$ is in $S$ then $v_1'$ also satisfies requirement (ii).  Otherwise, the parent of $v_1'$ is $v_0'$, in which case $v_0'$ satisfies requirements (i)--(iii).
\end{proof}

\begin{lem}\label{two_paths}
  Let $h\ge 2$, let $T_h$ be a complete binary tree of height $h$ with root $v_0$, and let $S\subseteq V(T_h)$ with $1\le |S|< 2^h-1$. Then there exists two vertices $v_1$ and $v_2$ of $T$ such that, for each $i\in\{1,2\}$ 
  \begin{compactenum}[(i)]
    \item the depth of $v_i$ is at most $\log_2(|S|)+2$;
    \item the parent of $v_i$ is in $S\cup\{v_0\}$; and
    \item $T_h-S$ contains a path from $v_i$ to a leaf of $T_h$.
  \end{compactenum} 
\end{lem}

\begin{proof}
  Let $T_1$ and $T_2$ be the two maximal subtrees of $T_h$ rooted at the children $v_1'$ and $v_2'$, respectively of $v_0$. (Each of $T_1$ and $T_2$ is a complete binary tree of height $h-1$.)  For each $i\in\{1,2\}$, let $S_i:=S\cap V(T_i)$.  Then $|S_i|< 2^{h-1}$, so we can apply \cref{one_path} to $T_i$ and $S_i$ to obtain a vertex $v_i$ of depth at most $1+\log_2|S_i| \le 1+\log_2 |S|$ and such that $T_h-S$ contains a path from $v_i$ to a leaf of $T_h$.  Therefore, $v_i$ satisfies (i) and (iii).  Furthermore, the parent of $v_i$ is in $S\cup\{v_i'\}$.  If the parent of $v_i$ is in $S$, then $v_i$ also satisfies (ii).  If the parent of $v_i$ is not in $S$, then the parent of $v_i$ is $v_i'\not\in S$ and $v_i'$ satisfies (i)--(iii).
\end{proof}

\subsection{A Connectivity Lemma}

The $x\times y$ grid $G_{x\times y}$ is the graph with vertex set $V(G_{x\times y}):=\{1,\ldots,x\}\times\{1,\ldots,y\}$ and that contains an edge $(x_1,y_1)$ and $(x_2,y_2)$ if and only if $|x_1-x_1|+|y_1-y_2|=1$.  An edge of $G_{x\times y}$ is \defin{horizontal} if its two endpoints agree in the second (y) coordinate.  For each $i\in\{1,\ldots,x\}$, $\{i\}\times\{1,\ldots,y\}$ is \defin{column $i$} of $G_{x\times y}$.  A set $C$ of columns is \defin{consecutive} if $G_{x\times y}[\cup C]$ is connected. 


\begin{lem}\label{grid_connectivity}
  Let $x,y,p\ge 1$ be integers, let $G$ be a graph obtained by subdividing horizontal edges of $G_{x\times y}$, and let $S\subseteq V(G-G_{x\times y})$ be a set of subdivision vertices of size $|S|< (p+1)y$.  Then some component of $G-S$ contains at least $x/(p+1)$ consecutive columns of $G_{x\times y}$.
\end{lem}

\begin{proof}
  For each $i\in\{1,\ldots,x-1\}$, in order to separate column $i$ from column $i+1$, $S$ must contain at least $y$ subdivision vertices that we introduced when subdividing horizontal edges between columns $i$ and $i+1$.  Since $|S|\le py$, this implies that there are at most $p$ values of $i\in\{1,\ldots,x-1\}$ for columns $i$ and $i+1$ are in different components of $G-S$. The result now follows from the Pigeonhole Principle.
\end{proof}

\subsection{The Construction}


We will construct a family $\mathcal{G}:=\{G_{h}:h\in\N\}$ of planar graphs with the following property:  There exists a fixed $\epsilon >0$ such that, for any tree $T$, any path $P$, $G_{b,h}\subseteq T\boxtimes P\boxtimes K_c$ implies that $c\ge h^\epsilon$.  Each graph $G_{h}$ is a planar supergraph of $T_h$ obtained by adding a path $P_i$ that contains all vertices of depth $i$, in order, for each $i\in\{1,\ldots,h\}$.   Since $T_h$ is a spanning subgraph of $G_h$, the \defin{depth} of a node $v$ in $G_h$ refers to the depth of $v$ in $T_h$.  

We now list some properties of $G_h$ that will be useful.  
Our first lemma shows that if $S$ is a small balanced separator of $G$ then $S$ contains many nodes of small depth.

\begin{lem}\label{small_depth_separator}
  There exists $a >0$ such that the following is true, for any $c>0$.
  If $S\subseteq V(G_h)$ has size $|S|\le ch$ and $G_h-S$ has no component with more than $|V(G)|/2$ vertices, then $S$ contains at least $ah/c$ nodes of depth at most $(1-a)h$. 
\end{lem}

\begin{proof}
  TODO. The idea is that a set of $ch$ nodes all of depth at least $(1-\alpha)h-\log_g(ch)$ can only separate about $ch2^{\alpha h}\ll n^{O(\alpha)}$ vertices from the rest of $G$.
\end{proof}


The following lemma shows that any tree partition of $G$ must have a node with a large genetically independent set that is far from the leaves of $\Gamma$.

\begin{lem}\label{startup}
  There exists $\alpha >0$ and $h_0:\N\to\N$ such that the following is true, for any $c\ge 1$ and any integer $h\ge h_0(c)$.  Let $\mathcal{T}:=\{B_x:x\in V(T)\}$ be a tree partition of $G_h$ of width less than $ch-1$.  Then there exists a node $x\in V(T)$ and a subset $R\subseteq B_x$ such that
  \begin{compactenum}[(i)]
    \item $R$ is genetically independent;
    \item $|R|\ge \alpha h/c$; and
    \item Each node in $R_0$ has depth at most $(1-\alpha)h$ 
  \end{compactenum}
\end{lem}


\begin{proof}
  It is well-known and easy to show that there exists a node $x$ of $T$ such that $G-B_x$ has no component with more than $|G|/2$ vertices.  Let $Y$ be the set of nodes in $B_x$ of depth at most $(1-\alpha)h-\log_2(ch)-1$. By \cref{small_depth_separator}, $|Y|\ge (1-a)h$.  Observe that, if $\alpha \le a-(\log_2(ch)-2)/h$\todo{Explain role of $h_0$ here.} and $\alpha \le a/3$ then $|Y|\ge 3\alpha h$.

  Suppose that no subset of $Y$ satisifies the conditions of the lemma, let $T_Y$ be the minimal (connected) subtree of $T_h$ that spans $Y$, and let $L$ the set of leaves in $T_Y$.  Observe that $L\subseteq Y$ is a genetically independent set. Therefore, $L$ satisfies (i) and, by definition, $L$ satisfies (iii).  Therefore, it must be that $|L|<\alpha h/c\le\alpha h$.  Let $Z$ consist of all vertices in $V(T_h)\setminus V(T_Y)$ whose parents are in $Y\setminus L$.   Observe that $Z$ is a genetically independent set. For each $v$ of $T_Y$, let $d_v$ denote the number of children $v$ has in $T_Y$.  Now,
  \[
     \sum_{v\in Y\setminus L} (d_v-1) + 1 
     \le \sum_{v\in V(T_Y)\setminus L} (d_v-1)+1
     = |L| \enspace ,
  \]
  where the second equality is a standard fact about rooted trees.
  Therefore $\sum_{v\in Y\setminus L} {d_v} \le |Y|$.  On the other hand,
  \[
    |Z| = \sum_{v\in Y\setminus L} (2-d_v) \enspace .
  \]
  Combining these two formulas, we obtain
  \[
    |Z| \ge 2|Y\setminus L| - |Y| = |Y| - 2|L| \ge 
    \ge 3\alpha h - 2\alpha h/c \ge \alpha h \enspace .
  \]
  For each $v\in Z$, \cref{one_path} implies that $v$ has a descendant $v'$ whose parent is in $B_x$, that has depth at most $(1-\alpha)h$ and such that $T_h-B_x$ contains a path $P_{v'}$ from $v'$ to a leaf descendant of $v'$.  Form the set $Z'$ by replacing each vertex $v\in Z$ with the vertex $v'$ just described.  Again, $Z'$ is a genetically independent set.

  Now observe that the union of $\bigcup_{v'\in Z'} P_{v'}$ and the paths $P_{h-\lceil\alpha h\rceil+1},\ldots,P_{h}$ contains a subgraph $G'$ isomorphic to a graph that can be obtained from the grid $G_{\lceil\alpha h\rceil\times\lceil\alpha h\rceil}$ by subdividing horizontal edges.  Since $S$ does not contain any vertex of $P_v'$ for any $v'\in Z'$,  $S\cap V(G')$ contains only vertices corresponding to subdivision vertices.  Therefore, by \cref{grid_connectivity}, some component of $G-B_x$ contains a subset $R_0\subseteq Z'$ of size at least $\alpha h/c$.  Each element in $R_0$ has a parent in $B_x$ so, by \cref{tree_thingy} some neighbour $y$ of $x$ in $T$ has a bag $B_y$ that contains $R_0$.  This completes the proof.
\end{proof}


A set $\mathcal{R}:=\{R_1,\ldots,R_r\}$ of subsets of $V(T_h)$ is \defin{$(k,\ell)$-great}\todo{pick a better name} if it has the following properties:

\begin{compactenum}
  \item For each $i\in\{1,\ldots,r\}$, $|R_i|\ge k$.
  \item For each $i\in\{1,\ldots,r\}$ there exists a common ancestor $a_i$ of $R_i$ such that $\dist_T(v,a_i)\le\ell$ for each $v\in R_i$.
  \item The common ancestors $\{a_1,\ldots,a_r\}$ are genetically independent.
\end{compactenum}

We say that a vertex $v$ of $T_h$ is \defin{compatible} with $S\subseteq V(T_h)$ if the parent of $v$ is in $S$ and $T_h-S$ contains a path from $v$ to a leaf of $T_h$.
  

\begin{lem}\label{compatible_set}
  Let $\mathcal{R}:=\{R_1,\ldots,R_r\}$ be $(k,\ell)$-great set consisting entirely of vertices of depth at most $h-d$ and let $S\supseteq \cup\mathcal{R}$ have size $|S|\le 2^d-2$.  Then, there exists a $(2k,\ell + \log_2(|S|)+2)$-great set $\mathcal{R}':=\{R_1',\ldots,R_r'\}$ that is compatible with $S$ consisting entirely of vertices of depth at most $h-d+\log_2(|S|)+2$.
\end{lem}

\begin{proof}
  For each $i\in\{1,\ldots,r\}$ and each $v_0\in R_i$, replace $v_0$ with the descendants $v_1$ and $v_2$ of $v_0$ described in \cref{two_paths} and call the resulting set $R_i'$.   Then $|R_i'|=2|R_i|\ge 2k$ and $\dist_{T_h}(v,a_i)\le \ell+\log_2(|S|)+2$ for each $v\in R_i$.  Therefore $\mathcal{R}'$ is a $(2k,\ell + \log_2(|R|)+2)$-great set consisting entirely of vertices of depth at most $h-d+\log_2(|S|)+2$..
\end{proof}

The next lemma completes the proof of \cref{main_thm}.
\begin{lem}
  There exists constants $\epsilon >0$ and $h_0\ge 1$ such that the following is true, for all $h \ge h_0$.  Let $L_0,\ldots,L_{2h}$ be any layering of $G$ and let $(B_x:x\in V(T))$ be a tree partition of $G$ of width less than $ch-1$.  Then there exists some $x\in V(T)$ and some $i\in\{0,\ldots,2h\}$ such that $|B_x\cap L_i| \ge h^{\epsilon}$.
\end{lem}

\begin{proof}
  By \cref{startup}, $T$ contains a node $x_1$ such that $B_{x_1}$ contains a genetically independent set $R$ of size $r_1:=|R|\ge \alpha h/c$ where each vertex in $R$ has depth at most $d_1:=(1-\alpha)h$.  Let $S_1:=B_{x_1}$ and $\mathcal{R}_1':=\{\{v\}:v\in R\}$.  By definition $\mathcal{R}_1'$ is a $(1,0)$-great set of size at least $\alpha h/c$.

  By \cref{compatible_set} (applied to $\mathcal{R}_1'$ and $S_1$), $T_h$ contains a $(2,\log_2(ch)+2)$-great set $\mathcal{R}_1$ of size $r_1$ that is compatible with $S_1$ containing only vertices of depth at most $d_2:=d_1+\log_2(ch)+2$.  For each $v\in\cup\mathcal{R}_1$, $T_h-S_1$ contains a path $P_v$ from $v$ to a leaf of $T_h$.  The union of the paths in $P_{d_2},\ldots,P_{h}$ and the paths in $\mathcal{C}_1:=\{P_v:v\in\cup\mathbb{R}_1\}$ contains a subgraph isomorphic to a graph that can be obtained from $G_{2r_1\boxtimes (h-d_1)}$ by subdividing horizontal edges.  Therefore, by \cref{grid_connectivity}, some component of $G-S_1$ contains at least $2r_1/c$ of that paths in $\mathcal{C}_1$.  Furthermore, these paths appear consecutively when we order $\mathcal{C}_1$ according to the order they appear in a depth-first traversal of $T_h$.  This implies that there is a subset $\mathcal{R}_2'\subseteq \mathcal{R}_1$ of size $r_2:=|\mathcal{R}_2'|\ge r_1/c$ that is contained in a single component of $G-S_1=G-B_{x_1}$. By \cref{dingy}, there is a neighbour $x_2$ of $x_1$ in $T$ with $\cup\mathcal{R}_2'\subseteq B_{x_2}$.

  We can now iterate this process of obtaining $\mathcal{R}_{i+1}'\subseteq S_{i+1}'$ from $\mathcal{R}_i'\subseteq S_i$. Let $t:= \lfloor \min\{\log_{2c} r_1,\alpha h/(2\log_2(ch)+4)\}\rfloor$. Then after $t-1$ such iterations we obtain a $(2^t,t(\log_2(ch)+2))$-great set $\mathcal{R}_t$ of size at least $r_t \ge r_1\alpha/(2c)^t \ge 1$, consisting entirely of vertices of depth at most $d_1+t(\log_2(ch)+2)$.

  Let $R$ be one of the sets in $\mathcal{R}_t$.  Since $\mathcal{R}_t$ is $(2^t,t(\log_2(ch)+2))$-great, $|R|\ge 2^t$ and all elements in $R$ have a common ancestor $a$ whose distance to each element of $R$ is at most $t(\log_2(ch)+2)$.  Therefore, $\diam_G(R)\le\diam_T(R)\le 2t(\log_2(ch)+2)+1$. By \cref{diameter_spread}, there exists some $L\in\mathcal{L}$ with
  \begin{align*}
    |L\cap B_{x_t}| 
    & \ge |L\cap R| \\
    & \ge \frac{|R|}{2t(\log_2(ch)+2)+1} \\ 
    & \ge \frac{2^t}{2t(\log_2(ch)+2)+1} \\
    & = \frac{2^{\Omega(\log h)}}{2t(\log_2(ch)+2)+1} \\
    & = \Omega(h^\epsilon) 
  \end{align*}
  for some fixed $\epsilon >0$.
\end{proof}



\section{Open Problems}

We know that every planar graph $G$ is contained in a product of the form $H\boxtimes P\boxtimes K_3$ where $\tw(H)\le 3$. \cref{main_thm} states that, for any $r$, there exists a max-degree-$5$ planar that is not contained in any product of the form $T\boxtimes P\boxtimes K_r$ where $T$ is a tree.  This leaves a few open problems:

\begin{enumerate}
  \item For each $\Delta\in\{3,4\}$, is it the case that any max-degree-$\Delta$ planar graph $G$ is contained in a product of the form $T\boxtimes P\boxtimes K_c$ where $T$ is a tree and $c$ is an absolute constant?

  \item Is it the case that any max-degree-$\Delta$ planar graph $G$ is contained in a product of the form $H\boxtimes P\boxtimes K_c$ where $\tw(H)\le 2$ and $c$ is upper by some function of $\Delta$?
\end{enumerate}


\bibliographystyle{plainurlnat}
\bibliography{tp}

\end{document}
