\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}
\usepackage{bbm}  % needed for \mathbbm{1}
\usepackage{listings}

\usepackage[normalem]{ulem}
\usepackage{cancel}
%\usepackage{enumitem}

\usepackage{todonotes}

% etoolbox allows for robust commands that don't need \protect, e.g.
% \newrobustcmd{\onesub}{\mathord{\includegraphics{figs/one-sub}}}
% \subsection{Approximate Voronoi Diagrams in $G^{\onesub}_k$}
\usepackage{etoolbox}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
% \linenumbers
% \rightlinenumbers
% \linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

\newcommand{\vol}[1]{\boxplus_{#1}}


\DeclareMathOperator{\interior}{Int}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}

\definecolor{brightmaroon}{rgb}{0.76, 0.13, 0.28}
\definecolor{linkblue}{rgb}{0, 0.337, 0.227}
\newcommand{\defin}[1]{\emph{\color{brightmaroon}#1}}
\setlength{\parskip}{1ex}

% Document-specific commands and math operators
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\td}{td}
\DeclareMathOperator{\chicen}{\chi_{\mathrm{cen}}}
\DeclareMathOperator{\chilin}{\chi_{\mathrm{lin}}}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\vor}{Vor}

% \newcommand{\SS}{\mathcal{S}}

\DeclareMathOperator{\binomial}{binomial}

\newrobustcmd{\onesub}{\mathord{\includegraphics{figs/one-sub}}}
\newrobustcmd{\leftup}{\mathord{\includegraphics{figs/left-up}}}

\title{\MakeUppercase{Bad News for Product Structure of Bounded-Degree Graphs}}
% \author{Prosenjit~Bose, Vida~Dujmović, Hussein~Houdrouge, Mehrnoosh~Javarsineh, and Pat~Morin}
\author{%
  Prosenjit Bose\thanks{School of Computer Science, Carleton University, Ottawa, Canada}\, \thanks{Research partly supported by NSERC.} \quad
  Gwenaël Joret\thanks{Affilation/funding} \quad
  Vida Dujmović\thanks{Department of Computer Science and Electrical Engineering, University of Ottawa, Ottawa, Canada.}\,\, \footnotemark[2] \quad
  Piotr Micek\thanks{Affilation/funding}\quad
  Pat Morin\footnotemark[1]\, \footnotemark[2] \quad
  David R. Wood\thanks{School of Mathematics, Monash University, Melbourne, Australia (\texttt{david.wood@monash.edu}). Research supported by the Australian Research Council.}
}

\DeclareMathOperator{\VE}{\mathit{VE}}

\date{}


\begin{document}

\maketitle
\renewcommand{\E}{\mathbb{E}}
\renewcommand{\Pr}{\mathbb{P}}

\begin{abstract}
  We give an example of a family $\mathcal{G}$ of planar graphs of maximum degree $5$ such that, if an $n$-vertex member of $\mathcal{G}$ is a subgraph of the product of a graph $H$, a path $P$ and a clique $K$ where $H$ has treewidth $t$ and maximum degree $\Delta$ and $K$ has order $r$, then $\log(t\Delta r) \in \Omega(\log n)$.
\end{abstract}

\section{Introduction}

Recently, product structure theorems and the related notion of row treewidth have been a key tool in resolving a number of longstanding open problems on planar graphs.  Roughly, a \defin{product structure theorem} for a graph family $\mathcal{G}$ states that there exists integers $t$ and $r$ such that, for every $G\in\mathcal{G}$ there is a graph $H$ of treewidth at most $t$ and a path $P$ such that $G$ is isomorphic to a subgraph of the strong product of $H$, $P$, and a clique $K$ of order $r$.\footnote{A \defin{tree decomposition} of a graph $H$ is a sequence $\mathcal{T}:=(B_x:x\in V(T))$ of subsets of $V(H)$ indexed by the nodes of some tree $T$ such that
\begin{inparaenum}[(i)]
  \item for each $v\in V(H)$, the induced subgraph $T[x\in V(T):v\in B_x]$ is connected; and
  \item for each edge $vw\in E(H)$, there exists some $x\in V(T)$ with $\{v,w\}\subseteq B_x$.
\end{inparaenum}
The \defin{width} of a tree decomposition of $\mathcal{T}$ is $\max\{|B_x|:x\in V(T)\}-1$. The \defin{treewidth} of $H$ is the minimum width of any tree decomposition of $H$.}\footnote{The \defin{strong product} $G_1\boxtimes G_2$ of two graphs $G_1$ and $G_2$ is the graph with vertex set $V(G_1\boxtimes G_2):=V(G_1)\times V(G_2)$ and that includes the edge with endpoints $(v,x)$ and $(w,y)$ if and only if
\begin{inparaenum}[(i)]
  \item $vw\in E(G_1)$ and $x=y$;
  \item $v=w$ and $xy\in E(G_2)$; or
  \item $vw\in E(G_1)$ and $xy\in E(G_2)$.
\end{inparaenum}
}
This is typically written as $G\subseteq H\boxtimes P\boxtimes K$, where the notation $G_1\subseteq G_2$ is used to mean that $G_1$ is isomorphic to some subgraph of $G_2$.

In applications of product structure theorems, it is often helpful if, in addition to having treewidth $t$, the graph $H$ has additional useful properties, possibly inherited from $G$.  For example, one very useful version of the planar product structure theorem states that for every planar graph $G$ there exists $H$ and $P$ with $G\subseteq H\boxtimes P\boxtimes K_3$ where the treewidth of $H$ is at most $3$ and $H$ is also \emph{planar}.  The planarity of $H$ in this result has been leveraged to obtain better constants and even asymptotic improvements for a number of graph colouring and layout problems.

One question that arises frequently (and which the authors have been asked repeatedly) is the following:
\begin{quote}
  Let $\mathcal{G}_\Delta$ be the family of planar graphs of maximum degree $\Delta$.  Does $\mathcal{G}_\Delta$ have a product structure theorem in which (in addition to having treewidth $t$) $H$ has maximum degree that is bounded by a function of $\Delta$?
\end{quote}
In this note we show that, unfortunately, the answer to this question is no, by proving the following:
% , even with $\Delta=5$.  We give a family of max-degree-$5$ planar graphs such that if an $n$-vertex member of this family is a subgraph of $H\boxtimes P\boxtimes K$ where $H$ has treewidth $t$, $H$ has maximum degree $\Delta$, and $K$ is a clique of order $r$, then $\log(r\Delta t)\in\Omega(\log\log n)$. In particular, we prove the following theorem:

\begin{thm}\label{treewidth_1_bounded_degree}
  For infinitely many integers $n\ge 1$, there exists an $n$-vertex max-degree-$5$\todo{change this} planar graph $G$ such that, for any treewidth-$t$ max-degree-$\Delta$ graph $H$, any path $P$, and any integer $r$,  if $G\subseteq H\boxtimes P\boxtimes K_r$ then $\log(t\Delta r)\in\Omega(\log n)$.
\end{thm}

\section{The New Proof}


\begin{obs}\label{diameter_spread}
  Let $G$ be any graph and let $R\subseteq V(G)$ and let $\mathcal{L}$ be any layering of $G$.  Then there exist some layer $L\in\mathcal{L}$ such that $|R\cap L|\ge |R|/(\diam_G(R)+1)$.
\end{obs}

\begin{proof}
  By the definition of layering, the vertices in $R$ appear in at most $\diam_G(R)+1$ consecutive layers of $\mathcal{L}$. The result then follows from the pigeonhole principle.
\end{proof}


\begin{lem}\label{percolation}
  Let $g\ge 2$ be an integer, let $b=2g-1$, let $\Gamma$ be a complete $b$-ary tree of height $h$, and let $S$ be a $w$-vertex subset of $V(\Gamma)$.  Then there exists a vertex $v\in S$ of depth $d\le\log_g (w)$ such that such that $\Gamma-(S\setminus\{v\})$ contains a tree rooted at $v$ that contains at least $g^i$ nodes of depth $i$, for each $i\in\{0,\ldots,h-d\}$.
\end{lem}

\begin{proof}
  The proof is by induction on $h$.  If $h=0$ then the statement is trivial.  Otherwise, let $v_0$ be the root of $\Gamma$ and let $\ell\ge 1$ be the minimum integer such that $G-(S\setminus\{v\})$ does not contain a complete $g$-ary tree of height $\ell$ rooted at $v_0$.  If $\ell=h+1$, then we can choose $v=\Gamma$ and we are done.  Otherwise, let $T$ be the tree that satisfies the requirement for $\ell-1$ and let $L_0$ denote the leaves of $T$.  The nodes in $L$ have a total of $d|L|\ge g^\ell-1$ children in the tree $\Gamma$.  At least $(d-g+1)|L|\ge g^{\ell}$ of these children must belong to $S$ since, otherwise $T$ could be extended to the first $\ell$ layers.  Each of these depth $\ell$ nodes in $S$ is the root of a subtree and one of these subtrees contains no more than $|S|/g^{\ell}$ elements of $S$. We can apply induction on this subtree to to find the required vertex $v$ at depth at most $\ell+\log_g(w/g^{\ell})=\log_g(w)$ in $\Gamma$.
\end{proof}


Let $b\ge 9$ be an integer.  We will construct a family $\mathcal{G}:=\{G_h:h\in\N\}$ of planar graphs with the following property:  There exists a fixed $\epsilon >0$ such that, for any tree $T$, any path $P$, $G_h\subseteq T\boxtimes P\boxtimes K_c$ implies that $c\ge h^\epsilon$.  To define $G_h$, let $\Gamma_h$ be an ordered complete $b$-ary tree of height $h$ and let $G_h$ be a planar supergraph of $\Gamma_h$ obtained by adding a path $P_i$ that contains all vertices of depth $i$, in order, for each $i\in\{1,\ldots,h\}$.   In the following, we drop the subscript $h$, so $G:=G_h$ and $\Gamma:=\Gamma_h$.

We now list some properties of $G$ that will be useful.  The following observation is an immediate consequence of \cref{diameter_spread}.

\begin{obs}\label{ancestor_spread}
  Let $R$ be a subset of $V(P_{i+\ell})$ having a common $\Gamma$-ancestor in $V(P_i)$.  Then, for any layering $\mathcal{L}$ of $G$, there exists a layer $L\in\mathcal{L}$ such that $|R\cap L|\ge |R|/(2\ell+1)$. 
\end{obs}

We say that a set $B\subset V(\Gamma)$ is \defin{genetically independent} if the no vertex of $B$ is an ancestor of any other vertex in $B$.  The following lemma shows that any tree partition of $G$ must have a node with a large genetically independent set that is far from the leaves of $\Gamma$.

\begin{lem}\label{startup}
  For any $c>0$ there exists $\alpha>0$ such that the following is true.
  Let $\mathcal{T}:=(B_x:x\in V(T))$ be a tree partition of $G$ of width at most $ch$.  Then there exists a node $x\in V(T)$ and a subset $R_0\subseteq B_x$ such that
  \begin{compactenum}[(i)]
    \item $R_0$ is genetically independent;
    \item $|R_0|\ge \alpha h/c$; and
    \item Each node in $R_0$ has depth at most $(1-\alpha)h$ 
  \end{compactenum}
\end{lem}

% \todo[inline]{Besides \cref{startup}, which can be proven using the fact that the quotient graph is $K_3$-minor free, the rest of the proof does not rely at all on the fact that $T$ is a tree.  In fact, we can rule out any $H$-partition of width $O(\log n)$ that includes even one bag with a set of vertices that satisfies the conclusion of \cref{startup}.  This gives some hope that we can rule out $\Gamma$ plus a matching on the leaves by looking for a $K_4$ in the quotient graph.}


\begin{proof}
  It is well-known and easy to show that there exists a node $x$ of $T$ such that $G-B_x$ has no component with more than $|G|/2$ vertices.  Let $Y$ be the set of nodes in $B_x$ of depth at most $(1-\alpha)h-\log_g(ch)$. 

  \todo[inline]{TODO: Argue that $|Y|\ge 2\alpha h$. The idea is that a set $ch$ nodes all of depth at least $(1-\alpha)h-\log_g(ch)$ can only separate about $chd^{\alpha h}(ch)^{\log_d(g)}\ll n^{O(\alpha)}$ vertices from the rest of $G$.}

  Suppose that no subset of $Y$ satisifies the conditions of the lemma, let $T_Y$ be the minimal (connected) subtree of $\Gamma$ that spans $Y$, and let $L$ the set of leaves in $T_Y$.  Since $L$ satisfies (i), it must be that $|L|<\alpha h/c$.  Let $Z$ consist of all vertices in $V(\Gamma)\setminus V(T_Y)$ whose $\Gamma$-parents are in $Y\setminus L$.   Observe that $Z$ is a genetically independent set. For each $v$ of $T_Y$, let $d_v$ denote the number of children $v$ has in $T_Y$.  Now,
  \[
     \sum_{v\in Y\setminus L} (d_v-1) + 1 
     \le \sum_{v\in V(T_Y)\setminus L} (d_v-1)+1
     = |L| \enspace ,
  \]
  where the second equality is a standard fact about rooted trees.
  Therefore $\sum_{v\in Y\setminus L} {d_v} \le |Y|$.  On the other hand,
  \[
    |Z| = \sum_{v\in Y\setminus L} (b-d_v) \enspace .
  \]
  Combining these two formulas, we obtain
  \[
    |Z| \ge b|Y\setminus L| - |Y| = (b-1)|Y| - b|L| \ge (b-1-1/2)|Y|
    \ge (2b - 3)\alpha h \ge \alpha h ,
  \]
  for $b\ge 2$.
  For each $v\in Z$, \cref{percolation} implies that $v$ has a descendant $v'$ whose parent is in $B_x$, that has depth at most $(1-\alpha)h$ and such that $\Gamma-B_x$ contains a path $P_{v'}$ from $v'$ to a leaf descendant of $v'$.  Form the set $Z'$ by replacing each vertex $v\in Z$ with the vertex $v'$ just described.  For two vertices $v',w'\in Z'$, $G$ contains $\alpha h$ internally disjoint paths that join $P_{v'}$ to $P_{w'}$.  The $ch$ vertices in $B_x$ can therefore only partition $Z'$ among at most $ch/\alpha h+1$ distinct components of $G-B_x$.  By the pigeonhole principle at least one of these components contains a subset $R_0\subseteq Z'$ of size at least $\alpha|Z'|/c$. Since $\mathcal{T}$ is a tree partition of $G$ and every vertex of $Z'$ is adjacent to a vertex in $B_x$, this implies that some neighbour $y$ of $x$ in $T$ has a bag $B_y$ that contains $R_0$.  This completes the proof.
\end{proof}

The next lemma is a more technical result.  Given two vertices $v,w\in V(\Gamma)$ neither of which is an ancestor of the other, we say that $v$ is \defin{left} of $w$ if the leaf descendants of $v$ appear in $P_h$ before the leaf descendants of $w$.

\begin{lem}\label{subtree_splitting}
  Let $p\in\{1,\ldots,h\}$, let $\{v_1,\ldots,v_r\}$ be a set of vertices of $G_h^-$, none of which is an ancestor of any other, ordered left to right.  For each $i\in\{1,\ldots,r\}$ let $d_i\le h-p$ be the depth of $v_i$ and let $T_i$ be a subgraph of $\Gamma$ consisting of a complete $3$-ary tree of height $h-d_i$ rooted at $v_i$.  Let $S\subseteq V(G)$ be a set that contains no vertex of $\bigcup_{i=1}^r V(T_i-v_i)$ and such that no component of $G-S$ contains $(T_i-v_i)\cup\cdots\cup (T_{i+q-1}-v_{i+q-1})$ for each $i\in\{1,\ldots,r-q+1\}$.  Then $|S\cap V_t|\ge \lfloor r/q\rfloor$ for each $t\in\{h-p+1,\ldots,h\}$.
\end{lem}

\begin{proof}
  For each $i\in\{1,\ldots,r\}$, let $w_{3i-2},w_{3i-1},w_{3i}$ be the roots of the trees in $T_i-v_i$, in left to right order.  For each $i\in\{1,\ldots,3r\}$, let $T'_i$ be the subtree rooted at $w_i$.  Observe that, for each $i\in\{1,\ldots,3r-1\}$, $G$ contains a set $X_{i}$ of $p$ vertex disjoint paths that begin at a vertex of $T'_{i}$ and end at a vertex of $T'_{i+1}$.  Indeed, there is one such path contained in $P_\ell$ for each $\ell\in\{h-p+1,\ldots,h\}$.

  Furthermore, for any $i\neq j$, the paths $X_i$ and $X_j$ have no internal vertices in common.  Since $T'_{3qt+1},\ldots,T'_{3q(t+1)}=T_{qt+1}-v_{qt+1},\ldots,T_{q(t+1)}-v_{q(t+1)}$ are not contained in a single component of $G-S$, there are two consective trees $T'_i$ and $T'_{i+1}$ that are separted by $S$ for some $i\in\{3qt+1,\ldots,3q(t+1)-1\}$.  Therefore, $S$ must contain at least one internal vertex from each of the $p$ paths in $X_{i}$.  Therefore $|S\cap V_t|\ge \lfloor r/q\rfloor$ for each $t\in\{h-p+1,\ldots,h\}$.\todo{Write the whole proof better. Probably not with $3$.}
\end{proof}

A set $\mathcal{R}:=\{R_1,\ldots,R_r\}$ of subsets of $V(\Gamma)$ is \defin{$k$-great}\todo{pick a better name} if it has the following properties:

\begin{compactenum}
  \item For each $i\in\{1,\ldots,r\}$, $|R_i|\ge k$.
  \item For each $i\in\{1,\ldots,r\}$, all nodes in $R_i$ have the same depth $d_i$ (so $R_i\subseteq V(P_{d_i})$.
  \item For each $1\le i<j\le r$, no node in $R_i$ is ancestor or descendant of a node in $R_j$.
\end{compactenum}

For a subset $S\subseteq V(\Gamma)$ and a depth-$d$ vertex $v\in S$, we say that $v$ is \defin{compatible} with $S$ if the component of $\Gamma-(S\setminus\{x\})$ contains a complete ternary tree of height $h-d$ rooted at $x$.  We say that $\mathcal{R}$ is compatible with $S$ if $\cup\mathcal{R}\subseteq S$ and $x$ is compatible with $S$ for each $x\in\cup\mathcal{R}$.  


\begin{lem}\label{compatible_set}
  For any $k$-great set $\mathcal{R}:=\{R_1,\ldots,R_r\}$ and any $S\supseteq \cup\mathcal{R}$, there exists a $\lceil k/2\rceil$-great set $\mathcal{R}':=\{R_1',\ldots,R_r'\}$ that is compatible with $S$ and such that, for each $i\in\{1,\ldots,r\}$ each vertex $v'\in R_i'$ has an ancestor $v\in R_i$ and $\depth_{\Gamma}(v')-\depth_{\Gamma}(v) \le \log_2|S|\cdot\log_3(w/(b-3))$.
\end{lem}

\begin{proof}
  If each $R_i$ contains a subset $R_i'$ of at least $\lceil k/2\rceil$ vertices that are compatible with $S$, then there is nothing to prove.  Suppose, therefore, that some $R_i$ contains fewer than $\lceil k/2\rceil$ vertices that are compatible with $S$.  Since $|R_i|\ge k$, this implies that more than $|R_i|/2$ vertices of $R_i$ are not compatible with $S$. Let $d_i$ be the depth of the nodes in $R_i$.  

  Suppose $x\in R_i$ is not compatible with $S$ and let $\ell\ge 1$ be the minimum integer such that $\Gamma-(S\setminus\{x\})$ does not contains a complete ternary tree of height $\ell$ rooted at $x$.  Observe that $S$ contains $3^{\ell-1}(b-3)$ descendants of $x$ of depth $d+\ell$ since, otherwise, the ternary tree of height $\ell-1$ rooted at $x$ could be extended to a ternary tree of height $\ell$.  When this occurs, we say that $x$ is an \defin{$\ell$-failure} and we let $f_\ell$ denote the number of $\ell$-failures in $R_i$.  Every vertex in $R_i$ that is incompatible with $S$ is an $\ell$-failure for some $\ell\ge 1$, so $|R_i|/2 < \sum_{\ell=1}^\infty f_\ell$.

  Since $S$ contains at most $w$ nodes of depth $d+\ell$, the number of $\ell$-failures is $f_\ell \le w/3^{\ell-1}(b-3)$.  This implies that there are no $\ell$-failures for any $\ell > \log_3 (w/(b-3)) + 1$.  
  Let $z:= \lfloor\log_3 (w/(b-3))\rfloor + 1$.

  We claim that, for some $\ell\in\{1,\ldots,z\}$, $f_\ell \ge 6|R_i|/3^{\ell}(b-3)$.  Indeed, otherwise
  \[
    |R_i|/2 < \sum_{\ell=1}^{\infty} f_\ell \le \frac{6|R_i|}{b-3}\cdot \sum_{\ell=1}^\infty 3^{-\ell} < \frac{6|R_i|}{b-3}\cdot \sum_{\ell=1}^\infty 3^{-\ell}
    = \frac{6|R_i|}{2(b-3)}  \le  |R_i|/2
  \]
  for $b\ge 9$. Therefore, for some $\ell\in\{1,\ldots,z\}$, $f_\ell\cdot 3^{\ell-1}(b-3) \ge 2|R_i|$.  When this happens, we replace $R_i$ by the subset of $S$ containing the depth $d+\ell$ descendants of nodes in $R_i$.  This operation ensures that $\mathcal{R}$ is a $k$-great set, that $S\supseteq \cup\mathcal{R}$, that the size of $R_i$ increases by a factor of at least $2$ and that the depth of $R_i$ increases by at most $z$. The new set $R_i$ may still have fewer than $k/2$ elements that are compatible with $S$, in which case we can repeat this operation.  Since $R_i\subseteq S$, all nodes in $R_i$ have the same depth $d_i$, and $|S\cap V(P_i)|\le w$ we can repeat this process at most $\log_2(w/k)\le \log_2(w)$ times before it must stop.  At this point, the resulting set $R_i$ contains at least $\lceil|R_i|/2\rceil\ge \lceil k/2\rceil$ elements that compatible with $S$ and has depth at most $z\log_2(w)$. By applying this procedure to each set $R_i$ that contains fewer than $k/2$ elements compatible with $S$ we obtain the desired $(k/2)$-great set $\mathcal{R}'$.
\end{proof}

For a vertex $v$ of $G$, let $N^\downarrow_{G}(v)$ denote the set of children of $v$ in $\Gamma$ and for a subset $S\subseteq V(\Gamma)$, let $N^\downarrow_G(S):=\bigcup_{v\in S}N^\downarrow_G(v)\setminus S$.

% \begin{obs}
%   Let $\mathcal{R}:=\{R_1,\ldots,R_r\}$ be a $k$-great that is compatible with some $S\supseteq \cup \mathcal{R}$ and where each $R_i$ has depth less than $h$.  Then $\mathcal{R}^{\downarrow}\{N^{\downarrow}_G(R_1),\ldots,N^{\downarrow}_G(R_r)\}$ is a $bk$-great set.
% \end{obs}



% \begin{lem}
%   Let $\mathcal{R}:=\{R_1,\ldots,R_r\}$ be a $k$-great that is compatible with some $S\supseteq \cup \mathcal{R}$ and such that $S$ contains at most $w$ elements of depth $i$ in $\Gamma$, for each $i\in\{0,\ldots,h\}$.  Then $G-\cup\mathcal{R}$ contains a component $C$
% \end{lem}


\begin{lem}
  There exists constants $\epsilon >0$ and $h_0\ge 1$ such that the following is true, for all s $h \ge h_0$.  Let $L_0,\ldots,L_{2h}$ be any layering of $G$ and let $(B_x:x\in V(T))$ be a tree partition of $G$ of width at most $ch$.  Then there exists some $x\in V(T)$ and some $i\in\{0,\ldots,2h\}$ such that $B_x\cap L_i| \ge h^{\epsilon}$.
\end{lem}

\begin{proof}
  By \cref{startup}, $T$ contains a node $x$ such that $B_x$ contains a set $R$ of size $|R|\ge \alpha h$ where each vertex in $R$ has $\Gamma$-depth at most $(1-\alpha)h$ and no vertex in $R$ is a $\Gamma$-ancestor of any other vertex in $R$.  Let $S_0:=B_x$ and $\mathcal{R}_0':=\{\{v\}:v\in R\}$.  By definition $\mathcal{R}_0'$ is a $1$-great set.

  % It is well known, and easy to prove, that $T$ contains a node $x_{-1}$ such that $G-B_{x_{-1}}$ has no component of order greater than $2|V(T)|/3$.
  % Since $B_{x_{-1}}\cap V_h \le w$, there exists a subpath of $P_h$ of length at least $(b^h-w)/(w+1)$ that contains no vertices of $B_{x_{-1}}$.  Let $C$ be the component of $G-B_{x_{-1}}$ that contains this subpath.  We claim that $C$ contains $r\ge ah$ vertices $v_1,\ldots,v_r$ whose $\Gamma$ parents are in $B_{x_{-1}}$ and each having depth at most $(1-a)h$.\todo{Prove this.}  

  % By definition, $v_1,\ldots,v_r$ are contained in $S_0:=B_{x_0}$ for some neighbour $x_0$ of $x_{-1}$.  Also by definition, $\{\{v_1\},\ldots,\{v_r\}\}$ is a $1$-great set $\mathcal{R}_0'$ contained in $S_0$.  

  Let $y:=\log_2(ch)\cdot\log_3(ch/(b-3))$.  By \cref{compatible_set} (applied to $\mathcal{R}_0'$ and $S_0$) $S_0$ contains a $1$-great set $\mathcal{R}_0$ of size $r_0/2$ that is compatible with $S_0$ and in which every vertex has $\Gamma$-depth at most $(1-a)h+y$.  

  For each vertex $v$ in $\mathcal{R}_0$, let $T_v$ denote the ternary tree rooted at $v$ that is guaranteed by the definition of compatibility. By \cref{subtree_splitting}, there exists $r_1\ge \alpha r_0/c$ vertices $v$ in $\mathcal{R}_0$ and a component $C_1$ of $G-S_0$ such that the three trees in $T_v-v$ are contained in $C_1$.  

  Form the set $\mathcal{R}_1'$ from $\mathcal{R}_0$ by replacing each such $v$ with the three roots of $T_v-\{v\}$.   Since each vertex of $\mathcal{R}_1'$ obtained this way is in $C_1$ and is ajacent to a vertex of $S_0$, $x_0$ has a neighbour $x_1$ in $T$ such that $S_1:=B_{x_1}$ contains $\cup\mathcal{R}_1'$.  That is, $\mathcal{R}_1$ is a $3$-great set contained in $S_1$.  Now apply \cref{compatible_set} to obtain a $\lceil 3/2\rceil$-great set $\mathcal{R}_1$ of size at least $r_1$ that is compatible with $S_1$ and whose elements have depth at most $(1-a)h+2y$.  We can now iterate this process of obtaining $\mathcal{R}_{i+1}$ from $\mathcal{R}_i$.  After $t-1$ such iterations we obtain a $\lceil(3/2)^t\rceil$-great set $\mathcal{R}_t$ of size at least $r_t \ge r_0(\alpha/c)^t \ge 1$, provided that 
  \[
    t \le \min\{\alpha/y, \log_{c/\alpha} r_0\} \enspace .
  \]
  Let $R$ be one of the sets in $\mathcal{R}_t$.  All the elements in $R$ have a common ancestor in $\cup\mathcal{R}_0$, which is at distance at most $ty$.  Therefore, by \cref{ancestor_spread}, there exists some $L\in\mathcal{L}$ with
  \[
    |L\cap B_{x_t}|\ge |L\cap R| \ge \frac{|R|}{2ty+1} 
    \ge \frac{(3/2)^t}{2ty+1}
    = \frac{(3/2)^{\Omega(\log h)}}{2\log_2(ch)\cdot\log_3(ch/(b-3))+1}
    = \Omega(h^\epsilon) 
  \] 
  for some $\epsilon >0$.
\end{proof}


% \section{Proof of \cref{treewidth_1_bounded_degree}}

% In this paper, all graphs are finite, undirected, and simple.  For two graphs $G_1$ and $G_2$ we use the notation $G_1=G_2$ to mean that $G_1$ and $G_2$ are isomorphic and the notation $G_1\subseteq G_2$ to mean that $G_1$ is isomorphic to some subgraph of $G_2$.  Note that, with this definition, the strong product of graphs is commutative, i.e., $G_1\boxtimes G_2=G_2\boxtimes G_1$.  Furthermore for any positive integers $p$ and $q$, $K_{p}\boxtimes K_{q}=K_{pq}$.

% We say that a graph $G$ is a \defin{max-degree-$\Delta$ graph} if it contains no vertex of degree greater than $\Delta$.  For a connected graph $G$ and two vertices $v,w\in V(G)$, $\dist_G(v,w)$ denotes the length of a shortest path in $G$ with endpoints $v$ and $w$.  The \defin{diameter} of $G$ is denoted $\diam(G):=\max\{\dist_G(v,w):v,w\in V(G)\}$.

% To obtain a short proof of \cref{treewidth_1_bounded_degree}, we make use of the following theorem, due to \citet{ding.oporowski:some} (see also \citet{wood:on}).\footnote{References \cite{ding.oporowski:some,wood:on} state \cref{tree_partition_theorem} in terms of tree partition width. It is straightforward to verify, using only the definitions of tree partition width and strong product that the two statements are equivalent.}

% \begin{thm}[\citet{ding.oporowski:some}]\label{tree_partition_theorem}
%   There exists a constant $c>0$ such that, for any treewidth-$t$ max-degree-$\Delta$ graph $G$, there exists a max-degree-$ct\Delta^2$ tree $T$ such that $G\subseteq T\boxtimes K_{ct\Delta}$.\todo{\cite{ding.oporowski:some,wood:on} don't mention the degree of $T$, but $ct\Delta^2$ is obvious, easy, and good enough. Reference?}
% \end{thm}

% \cref{tree_partition_theorem} allows us to prove \cref{treewidth_1_bounded_degree} by focusing on the case in which $H$ has treewidth $1$, because of the following corollary:

% \begin{cor}\label{tree_partition_corollary}
%   There exists a constant $c>0$ such that, for any treewidth-$t$ maximum-degree-$\Delta$ graph $H$, any path $P$, and any $r\ge 1$, there exists a max-degree-$ct\Delta^2$ tree $T$ such that $H\boxtimes P\boxtimes K_r \subseteq T\boxtimes P\boxtimes K_{crt\Delta}$.
% \end{cor}

% \begin{proof}
%   Apply \cref{tree_partition_theorem} to $H$ to obtain a maximum-degree-$ct\Delta^2$ tree $T$ such that $H\subseteq T\boxtimes K_{ct\Delta}$.  Then $H\boxtimes P\boxtimes K_{r} \subseteq T\boxtimes K_{ct\Delta}\boxtimes P\boxtimes K_r=T\boxtimes P\boxtimes K_{crt\Delta}$.
% \end{proof}

% Thus, we establish \cref{treewidth_1_bounded_degree} using the following lemma.

% \begin{lem}\label{easy_version}
%   For infinitely many positive integers $n$, there exists an $n$-vertex max-degree-$5$ planar graph $G$ such that, for any max-degree-$\Delta$ tree $T$, if $G\subseteq T\boxtimes P\boxtimes K_r$ then $\log (\Delta r)\ge (1-o(1))\log n$.
% \end{lem}

% Before proving \cref{easy_version}, we show how it implies \cref{treewidth_1_bounded_degree}.

% \begin{proof}[Proof of \cref{treewidth_1_bounded_degree}]
%   Let $G$ be an $n$-vertex graph whose existence is the subject of \cref{easy_version}.  Let $H$ be a treewidth-$t$ max-degree-$\Delta$ graph such that $G\subseteq H\boxtimes P\boxtimes K_r$.  Then, by \cref{easy_version}, there exists a max-degree-$ct\Delta^2$ tree $T$ such that $G\subseteq T\boxtimes P\boxtimes K_{crt\Delta}$.  Since $G$ comes from \cref{easy_version}, $\log(c^2rt^2\Delta^3)\ge (1-o(1))\log n$. \cref{treewidth_1_bounded_degree} now, since $\log(t\Delta r)\in\Omega(\log crt^2\Delta^3)$.
% \end{proof}

% \begin{proof}[Proof of \cref{easy_version}]
%   Let $n:=2^{h+1}-1$ for some large positive integer $h$, and let $\Gamma$ be a complete binary tree of height $h$ (so $\Gamma$ has exactly $n$ vertices and $2^h$ leaves).  Define $G$ to be the supergraph of $\Gamma$ obtained by adding, for each $i\in\{0,\ldots,h\}$, the edges of a path $P_i$ that contains all $2^{h-i}$ nodes of depth $h-i$ in $\Gamma$.  Observe that $\diam(G)\le\diam(\Gamma)=2h$.

%   Now suppose $G\subseteq T\boxtimes P\boxtimes K_r$ and fix an injective homomorphism $\rho:V(G)\to V(T\boxtimes P\boxtimes K_r)$.  For two vertices $v$ and $w$ of $G$ with $\rho(v):=(v_1,v_2,v_3)$ and $\rho(w):=(w_1,w_2,w_3)$ we call $v_1$, $v_2$, and $v_3$ the \defin{projections} of $v$ onto $T$, $P$, and $K_r$, respectively.  For simplicity, we define $\dist_T(v,w):=\dist_T(v_1,w_1)$ and $\dist_P(v,w):=\dist_P(v_2,w_2)$.  Then, by the definition of strong product, $\dist_G(v,w)\ge \max\{\dist_T(v,w),\dist_P(v,w)\}$.  Since $\diam(G)\le 2h$, this allows us to assume that $\diam(P)\le 2h$ and that $\diam(T)\le 2h$.  The former inequality implies that $|V(P)|\le 2h+1$.  However, the latter inequality only implies that $|V(T)|\in O(n^2)$, which is insufficient for our purposes.

%   Our strategy will be to show that the projection of $P_0$ onto $T$ defines a subtree $T'\subseteq T$ with $|V(T')|\le \Delta^{O(h/\log h)}$.  Since $\rho$ is injective, $2^h=|V(P_0)|\le |V(T'\boxtimes P\boxtimes K_r)|$. Therefore,
%   \[
%     2^h = |V(P_0)| \le |V(T'\boxtimes P\boxtimes K_r)| \le r(2h+1)\Delta^{O(h/\log h)} = r\Delta\cdot 2^{O(\log h + h/\log h)}
%   \]
%   and rewriting this gives $\log(r\Delta) \ge h-O(\log h+h/\log h)=(1-o(1))\log n$, as required.  All that remains is to prove that $|V(T')|\le\Delta^{O(h/\log h)}$.  Since $T$ is max-degree-$\Delta$, so is $T'$, so it suffices to show that $\diam(T')=O(h/\log h)$, which we do next.

%   For each $i\in\{0,\ldots,h-1\}$, let
%   Let $d_i=\max\{\dist_T(v,w):v,w\in V(P_i)\}$.  Since $P_i$ is a path that contains exactly $2^{h-i}$ vertices, $d_i \le \diam(P_i) = 2^{h-i}-1$. Let $v$ and $w$ be two vertices of $P_i$ such that $\dist_T(v,w)=d_i$.  Observe that $P_{i+1}$ contains two vertices $x,y$ with $xv, yw\in E(G)$, which implies that $\dist_T(x,v)\le 1$ and $\dist_T(y,w)\le 1$.  By the triangle inequality, we have
%   \[
%     \dist_T(v,w) \le \dist_T(v,x)+\dist_T(x,y)+\dist_T(y,w) \le \dist_T(x,y)+2 \enspace .
%   \]
%   Therefore,
%   \[
%      d_{i+1} \ge \dist_T(x,y) \ge \dist_T(v,w)-2= d_i-2 \enspace ,
%   \]
%   for each $i\in\{0,\ldots,h-1\}$.  Beginning at $i=0$ and iterating this inequality implies that $d_i \ge d_0-2i$ for each $i\in\{0,\ldots,h\}$.
%   Putting these upper and lower bounds together, we find that
%   \[
%     2^{h-i} \ge d_i \ge d_0-2i \enspace ,
%   \]
%   so
%   \begin{equation}
%     d_0 \le 2^{h-i}+2i  \label{d_i_bound}
%   \end{equation}
%   for each $i\in\{0,\ldots,h\}$.  Since $0\le d_0\le\diam(T)\le 2h$ it follows that $\lfloor d_0/4\rfloor\in\{0,\ldots,h\}$ so applying \cref{d_i_bound} with $i=\lfloor d_0/4\rfloor$ we obtain
%   \[
%     d_0 \le 2^{h-\lfloor d_0/4\rfloor} + d_0/2 \le 2^{h-d_0/4+1} + d_0/2 \enspace .
%   \]
%   Rewriting and simplifying gives $d_02^{d_0/4}\le 2^h$ which implies that $d_0 = O(h/\log h)$.\todo{Big dumb mistake right here!}  This completes the proof.
% \end{proof}

% \section{A Strengthening of \cref{treewidth_1_bounded_degree}}

% By \cref{tree_partition_theorem}, \cref{treewidth_1_bounded_degree} is equivalent to \cref{easy_version}, which states that there are planar max-degree-$5$ graphs $G$ that are not subgraphs of $T\boxtimes P\boxtimes K_r$ unless the degree $\Delta$ of $T$ is large or the order $r$ of the clique $K_r$ is large.  In this section, we strengthen \cref{treewidth_1_bounded_degree} by showing that the result holds even if we allow the degree $\Delta$ of $T$ to be arbitrarily large.


% \begin{lem}\label{hard_version}
%   There exists a constant $\epsilon >0$ such that, for infinitely many positive integers $n$, there exists an $n$-vertex max-degree-$5$ planar graph $G$ such that, for any tree $T$, if $G\subseteq T\boxtimes P\boxtimes K_r$ then $r\in\Omega(\log^\varepsilon n)$.
% \end{lem}

% \todo[inline]{This whole section could use some work.  At the very least, we probably want a lemma/observation which states that if $W_{i-1}$ crosses an edge $vw$ of $T$ then $W_i$ visits at least one of $v$ or $w$.}

% \begin{proof}
%   Let $G$, $P_0,\ldots,P_h$, and $d_0,\ldots,d_h$, $\rho$, and $T'$ be exactly as in the proof of \cref{easy_version}.  The same arguments used there also apply here to establish that $|V(P)|\le 2h+1$ and that $\diam(T')\in O(h/\log h)$.  However, without any bound on the maximum degree of $T$, it is no longer possible to establish a useful upper bound on $|V(T')|$.

%   Consider the lazy walk $W_0:=w_{0,1},\ldots,w_{0,2^h}$ in $T'$ obtained by projecting the path $P_0$ onto $T$.  Suppose that some node $x$ of $T'$ has degree $\delta$.  Then the walk $W_0$ must visit $x$ at least $\delta-1$ times.  To see why this is so, consider the components $T_1,\ldots,T_\delta$ of $T'-\{x\}$ and for each $i\in\{1,\ldots,\delta\}$ let $\tau(i)=\min\{j\in \{1,\ldots,2^h\}: w_j\in V(T_i)\}$.  Without loss of generality, we may assume that $\tau(1) < \tau(2) <\cdots < \tau(\delta)$.  In other words, $W_0$ visits some vertex of $T_i$ before visiting any vertex of $T_{i+1}$, for each $i\in\{1,\ldots,\delta-1\}$.  Since $w_{\tau(i)}$ and $w_{\tau(i+1)}$ are in different components of $T-x$, it is follows immediately that $x$ appears at least once in $w_{\tau(i)+1},\ldots,w_{\tau(i+1)-1}$ for each $i\in\{1,\ldots,\delta\}$.

%   Since $W_0$ visits $x$ at least $\delta-1$ times, $\rho(P_0)$ contains at least $\delta-1$ vertices in $\{x\}\times V(P)\times V(K_r)$, which implies that $\delta \le (2h+1)r + 1$.  Therefore, $T'$ is a tree of height $O(\log h/\log\log h)$ and of maximum degree $O(hr)$.

%   \begin{clm}\label{big_logeps_subdivision}
%     There exists a fixed constant $\epsilon >0$
%     $T'$ contains a subtree $\Gamma$ that is isomorphic to a subdivision of a complete $\lceil h^\epsilon\rceil$-ary tree of height $h'\ge\epsilon\log h/\log\log h$.
%   \end{clm}

%   \begin{proof}
%     Do some Kraft-like counting.
%   \end{proof}

%   Let $\delta:=\lceil h^{\epsilon}\rceil+1$ and say that a node $x$ of $\Gamma$ is a \defin{branching node} if it has degree $\delta$ in $G_h^-$.

%   \begin{clm}
%     $G_h^-$ contains a path $X_0$ such that $W_0$ visits every branching node of $G_h^--X_0$ at least $\delta$ times.
%   \end{clm}

%   \begin{proof}
%     Say that a branching node $x$ of $G_h^-$ is \defin{light} if $x$ appears exactly $\delta-1$ times in $W_0$. Using the notation above, $x$ is light because $W_0$ visits $x$ exactly $\delta-1$ times and then remains in $T_\delta$.  Whenever this occurs at a node $x$, \defin{direct} the edge of $G_h^-$ that joint $x$ to $T_\delta$ away from $x$. Leave all other edges undirected.  In this way, each light branching node of $G_h^-$ has exactly one of its incident edges directed away from it.  Now observe that, if $x$ and $y$ are two light nodes of $G_h^-$ resulting in directed edges $e_x$ and $e_y$, then the path $P_{xy}$ in $G_h^-$ with endpoints $x$ and $y$ contains exactly one of $e_x$ or $e_y$.  We say that $x\prec y$ if $e_x$ is in $P_{xy}$ and $y\prec x$ if $e_y$ is in $P_x$.  Then the relationship $\prec$ is a total order on the light nodes of $G_h^-$ and there is a path $X_0$ that visits all these vertices in this order.
%   \end{proof}


%   For each $i\in\{0,\ldots,h'\}$, let $T_i$ be the subtree of $T$ visited by $W_i$ and let $Z_i$ be the set of branching nodes in $G_h^-$ that have exactly $h-i$ branching ancestors (including themselves).

%   \begin{clm}
%     For each $i\in\{0,\ldots,h\}$, $T_i$ contains every node in $\bigcup_{j=i}^{h'}Z_j$.
%   \end{clm}

%   \begin{proof}
%     The proof is by induction on $i$. In the base case $i=0$ is true by the definition of $G_h^-$.  For $i\ge 1$, the inductive hypothesis implies that $W_{i-1}$ visits all branching nodes in $Z_{i-1}$. The walk $W_{i}$ ``follows'' $W_{i-1}$ in the sense that, for each $j\in\{1,\ldots,2^{h-i}\}$, $w_{i,j}$ is ajacent to, or equal to each of $w_{i-1,2j-1}$ and $w_{i-1,2j}$.  In particular, this implies that $W_i$ contains every vertex of $Z_i$. Since $W_i$ is a (lazy) walk in $T$, and $T$ is a tree, this implies that $W_i$ contains every branching ancestor of every node in $Z_i$.  Therefore, $W_i$ contains every vertex of $\bigcup_{j=i}^{h'} Z_j$, as required.
%   \end{proof}

%   At this point we are done.  Let $i:=\lfloor h'/2\rfloor$, so $i\in\Omega(h/\log h)$.  $G_h^-$ contains $\delta^i \in 2^{\Omega(h\log\delta/\log h)}$  nodes of $Z_i$.  For each $j\in\{0,\ldots,i\}$ at most two elements of $Z_i$ are visited fewer than $\delta$ by $W_j$.  Since $2i < |Z_i|$, there exists a node $x$ in $Z_i$ that is visited at least $\delta$ times by each of $W_0,\ldots,W_i$, for a total of $i\delta \in \Omega(h^{1+\epsilon}/\log h)$ times. This implies that $\rho$ maps at least $i\delta$ vertices of $G$ onto $\{x \}\times P\times K_r$, which implies that $i\delta\le (2h+1)r$, so $r\in\Omega(h^\epsilon/\log h)$.  The result now follows by taking $\varepsilon := \epsilon/2$.
% \end{proof}


\section{An Open Problem}

We know that every planar graph $G$ is contained in a product of the form $H\boxtimes P\boxtimes K_3$ where $\tw(H)\le 3$. \cref{hard_version} states that, for any $r$, there exists a max-degree-$5$ planar that is not contained in any product of the form $T\boxtimes P\boxtimes K_r$ where $T$ is a tree.  This leaves the treewidth-$2$ case open:

\begin{quote}
  Is it the case that any max-degree-$\Delta$ planar graph $G$ is contained in a product of the form $H\boxtimes P\boxtimes K_r$ where $\tw(H)\le 2$ and $r$ is upper by some function of $\Delta$?
\end{quote}

\bibliographystyle{plainurlnat}
\bibliography{tp}

\end{document}
